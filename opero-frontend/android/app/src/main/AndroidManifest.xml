/**
 * File: /opero-frontend/src/shared/AllegatiManager.js
 *
 * Versione: 2.6 (Rimozione Sfondo Client-Side)
 *
 * Descrizione:
 * - Aggiunge la libreria '@imgly/background-removal' (da installare).
 * - L'upload di immagini non è più immediato.
 * - Dopo aver scattato/selezionato una FOTO, appare un'anteprima
 * con il pulsante "Rimuovi Sfondo".
 * - L'elaborazione avviene sul dispositivo (client-side).
 * - Mantiene l'integrazione Capacitor (v2.5) e Miniature (v2.4).
 */

import React, { useState, useEffect, useCallback } from 'react';
import { useDropzone } from 'react-dropzone';
import { api } from '../services/api';
import axios from 'axios';
import { useAuth } from '../context/AuthContext';
import ConfirmationModal from './ConfirmationModal';
import { toast } from 'react-toastify';

// --- (v2.6) Importa la libreria di rimozione sfondo ---
// RICORDA: Esegui `npm install @imgly/background-removal`
import { removeBackground } from "@imgly/background-removal";

// --- (v2.5) Import Capacitor ---
import { Capacitor } from '@capacitor/core';
import { Camera, CameraResultType } from '@capacitor/camera';

// Import icone (lucide-react)
import {
    Paperclip, Download, Trash2, FileText, FileImage, FileArchive, File,
    AlertTriangle, UploadCloud, Loader2, Eye, Camera as CameraIcon,
    Wand2, X // (v2.6) Aggiunte icone Wand2 (bacchetta) e X (annulla)
} from 'lucide-react';

// --- Helper Interni ---

const FileIcon = ({ mimeType }) => {
    if (!mimeType) return <File className="w-6 h-6 text-gray-500" />;
    if (mimeType.startsWith('image/')) {
        return <FileImage className="w-6 h-6 text-blue-500" />;
    }
    if (mimeType === 'application/pdf') {
        return <FileText className="w-6 h-6 text-red-500" />;
    }
    if (mimeType.startsWith('application/zip') || mimeType.includes('compressed')) {
        return <FileArchive className="w-6 h-6 text-yellow-600" />;
    }
    return <File className="w-6 h-6 text-gray-500" />;
};

const formatFileSize = (bytes) => {
    if (!bytes || bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
};

const formatFileDate = (dateString) => {
    try {
        return new Date(dateString).toLocaleDateString('it-IT', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
        });
    } catch (e) {
        return 'Data non valida';
    }
};

const isCapacitor = Capacitor.isNativePlatform();

// --- (v2.6) Funzione per convertire URL (blob, webPath) in File ---
const urlToFile = async (url, fileName, mimeType) => {
    const response = await fetch(url);
    const blob = await response.blob();
    return new File([blob], fileName, { type: mimeType });
};


const AllegatiManager = ({ entita_tipo, entita_id }) => {
    const { loading, hasPermission } = useAuth(); 
    
    // Stato dati
    const [allegati, setAllegati] = useState([]);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState(null);

    // Stato per l'upload
    const [uploadingFiles, setUploadingFiles] = useState([]); 
    const [isAllegatoDeleteModalOpen, setIsAllegatoDeleteModalOpen] = useState(false);
    const [allegatoLinkToDelete, setAllegatoLinkToDelete] = useState(null);

    // --- (v2.6) Stato per la rimozione sfondo ---
    // File in attesa di elaborazione (un oggetto { file, previewUrl })
    const [fileToProcess, setFileToProcess] = useState(null); 
    // Loader per l'elaborazione AI
    const [isProcessing, setIsProcessing] = useState(false);
    // --- Fine stato ---

    // (v2.6) Funzione per avviare l'upload
    // Chiamata da "Carica File" o dopo "Rimuovi Sfondo"
    const startUpload = (file) => {
        const newUpload = {
            id: `${file.name}-${file.lastModified}`,
            file,
            progress: 0,
            error: null,
        };
        setUploadingFiles(prev => [...prev, newUpload]);
        performUpload(newUpload);
        
        // Pulisce il file in elaborazione
        setFileToProcess(null);
    };

    // (v2.6) Funzione di elaborazione AI (Client-side)
    const handleProcessBackground = async () => {
        if (!fileToProcess) return;

        setIsProcessing(true);
        setError(null);
        try {
            // 1. Elabora l'immagine (usa l'URL per l'input)
            const blob = await removeBackground(fileToProcess.previewUrl);

            // 2. Converte il Blob risultante in un File .png (per la trasparenza)
            const newFileName = fileToProcess.file.name.replace(/\.[^/.]+$/, "") + "_no-bg.png";
            const processedFile = new File([blob], newFileName, { type: 'image/png' });

            // 3. Avvia l'upload con il nuovo file
            startUpload(processedFile);

        } catch (err) {
            console.error("Errore durante la rimozione dello sfondo:", err);
            setError("Errore AI: Impossibile elaborare l'immagine. Assicurati che il modello AI sia caricato.");
            setFileToProcess(null); // Pulisce in caso di errore
        } finally {
            setIsProcessing(false);
        }
    };


    const fetchAllegati = useCallback(async () => {
        if (!entita_tipo || !entita_id) return;
        setIsLoading(true);
        setError(null);
        try {
            const res = await api.get(`/documenti/list/${entita_tipo}/${entita_id}`);
             const allegatiConNome = res.data.map(a => ({
                ...a,
                utente_upload: (a.utente_nome || a.utente_cognome)
                    ? `${a.utente_nome || ''} ${a.utente_cognome || ''}`.trim()
                    : (a.utente_nome === null ? 'Utente Eliminato' : 'N/D') 
            }));
            setAllegati(allegatiConNome);
        } catch (err) {
            console.error("Errore nel caricamento degli allegati:", err);
            setError(err.response?.data?.error || "Impossibile caricare gli allegati.");
        } finally {
            setIsLoading(false);
        }
    }, [entita_tipo, entita_id]);

    useEffect(() => {
        if (!entita_tipo || !entita_id) return;
        if (loading) return; 
        fetchAllegati();
    }, [fetchAllegati, loading]);

    // (v2.6) Modificato: non avvia l'upload, ma imposta l'anteprima
    const handleFileSelected = (file) => {
        if (!file) return;

        // Se è un'immagine, la mettiamo in elaborazione
        if (file.type.startsWith('image/')) {
            setFileToProcess({
                file: file,
                previewUrl: URL.createObjectURL(file) // Crea un URL locale per l'anteprima
            });
        } else {
            // Se non è un'immagine (PDF, ZIP), la carichiamo subito
            startUpload(file);
        }
    };
    
    // (v2.6) Modificato: onDrop ora usa handleFileSelected
    const { getRootProps, getInputProps, isDragActive } = useDropzone({
        onDrop: (acceptedFiles) => handleFileSelected(acceptedFiles[0]), // Prende solo il primo file
        noClick: !hasPermission('DM_FILE_UPLOAD'),
        noKeyboard: !hasPermission('DM_FILE_UPLOAD'),
        disabled: !hasPermission('DM_FILE_UPLOAD'),
        multiple: false // Accetta un file alla volta
    });

    // (v2.6) Modificato: handleTakePhoto ora usa handleFileSelected
    const handleTakePhoto = async () => {
        if (!hasPermission('DM_FILE_UPLOAD')) {
            toast.error("Non hai i permessi per caricare foto."); 
            return;
        }
        try {
            const image = await Camera.getPhoto({
                quality: 90,
                allowEditing: false, 
                resultType: CameraResultType.Uri
            });

            const fileName = `foto_${new Date().getTime()}.jpg`;
            const file = await urlToFile(image.webPath, fileName, 'image/jpeg');

            // Invia il file alla logica di selezione
            handleFileSelected(file);

        } catch (error) {
            if (error.message.includes("User cancelled")) {
                console.log("Acquisizione foto annullata dall'utente.");
            } else {
                console.error("Errore durante l'acquisizione della foto:", error);
                setError("Impossibile acquisire la foto dalla fotocamera.");
            }
        }
    };

    const performUpload = async (upload) => {
        const { file } = upload;
        const setUploadStatus = (progress, error = null) => {
            setUploadingFiles(prev =>
                prev.map(u =>
                    u.id === upload.id ? { ...u, progress, error: error ? error.toString() : null } : u
                )
            );
        };

        try {
            setUploadStatus(10); 
            const resUrl = await api.post('/documenti/generate-upload-url', {
                fileName: file.name, fileSize: file.size, mimeType: file.type,
            });
            const { uploadUrl, s3Key } = resUrl.data;
            setUploadStatus(30); 
            await axios.put(uploadUrl, file, {
                headers: { 'Content-Type': file.type },
                onUploadProgress: (progressEvent) => {
                    if (progressEvent.total) {
                        const percent = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                        setUploadStatus(30 + (percent * 0.6)); 
                    }
                },
            });
            setUploadStatus(95);
            await api.post('/documenti/finalize-upload', {
                s3Key, fileName: file.name, fileSize: file.size, mimeType: file.type,
                entita_tipo, entita_id,
            });
            setUploadStatus(100);
            fetchAllegati(); 
            setTimeout(() => setUploadingFiles(prev => prev.filter(u => u.id !== upload.id)), 1000);
        } catch (err) {
            console.error("Errore durante l'upload:", err);
            const errMsg = err.response?.data?.error || err.message || "Errore sconosciuto";
            setUploadStatus(0, errMsg); 
        }
    };

    const handleDownload = async (file) => {
        if (!hasPermission('DM_FILE_VIEW')) return;
        try {
            const res = await api.get(`/documenti/generate-download-url/${file.id_file}`);
            const { downloadUrl } = res.data;
            window.open(downloadUrl, '_blank');
        } catch (err) {
            console.error("Errore nel download:", err);
            setError(err.response?.data?.error || "Impossibile generare il link per il download.");
        }
    };

    const handleDeleteClick = (link) => {
        if (!hasPermission('DM_FILE_DELETE')) return;
        setAllegatoLinkToDelete(link);
        setIsAllegatoDeleteModalOpen(true);
    };

    const confirmDelete = async () => {
        if (!allegatoLinkToDelete) return;
        try {
            await api.delete(`/documenti/link/${allegatoLinkToDelete.id_link}`);
            setAllegati(prev => prev.filter(a => a.id_link !== allegatoLinkToDelete.id_link));
        } catch (err) {
            console.error("Errore nell'eliminazione dell'allegato:", err);
            setError(err.response?.data?.error || "Impossibile eliminare l'allegato.");
        } finally {
            setIsAllegatoDeleteModalOpen(false);
            setAllegatoLinkToDelete(null);
        }
    };

    // 3. RENDERING
    if (loading) {
        return (
            <div className="w-full max-w-4xl mx-auto flex justify-center items-center py-8">
                <Loader2 className="w-8 h-8 text-blue-500 animate-spin" />
                <span className="ml-3 text-gray-600">Caricamento permessi...</span>
            </div>
        );
    }

    if (typeof hasPermission !== 'function') {
        return (
            <div className="w-full max-w-4xl mx-auto text-center py-8 text-red-600">
                Errore Critico: Contesto di autenticazione non disponibile. Assicurati che il componente sia avvolto da AuthProvider.
            </div>
        );
    }

    // --- 4. RENDERING DEL CONTENUTO ---
    return (
        <div className="w-full max-w-4xl mx-auto">
            <h3 className="text-lg font-semibold text-gray-700 mb-4">Gestione Allegati</h3>
            
            {/* Messaggio di Errore Globale */}
            {error && (
                <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative my-4" role="alert">
                    <span className="block sm:inline">{error}</span>
                </div>
            )}

            {/* --- (v2.6) Sezione Elaborazione Immagine --- */}
            {fileToProcess && (
                <div className="relative mb-4 p-4 border border-blue-300 bg-blue-50 rounded-lg shadow-lg">
                    <h4 className="text-lg font-semibold text-blue-800 mb-3">Elabora Immagine</h4>
                    <div className="flex flex-col md:flex-row gap-4 items-center">
                        <img 
                            src={fileToProcess.previewUrl} 
                            alt="Anteprima" 
                            className="w-32 h-32 object-cover rounded-md border-2 border-blue-200"
                        />
                        <div className="flex-1 space-y-3">
                            <p className="text-sm text-gray-700 truncate" title={fileToProcess.file.name}>{fileToProcess.file.name}</p>
                            
                            {/* Pulsante Rimuovi Sfondo */}
                            <button
                                type="button"
                                onClick={handleProcessBackground}
                                disabled={isProcessing}
                                className="w-full flex justify-center items-center gap-2 px-4 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-md hover:bg-blue-700 transition-colors disabled:bg-blue-300"
                            >
                                {isProcessing ? (
                                    <Loader2 className="w-5 h-5 animate-spin" />
                                ) : (
                                    <Wand2 className="w-5 h-5" />
                                )}
                                {isProcessing ? "Elaborazione AI..." : "Rimuovi Sfondo"}
                            </button>
                            
                            {/* Pulsante Carica Originale */}
                            <button
                                type="button"
                                onClick={() => startUpload(fileToProcess.file)}
                                disabled={isProcessing}
                                className="w-full flex justify-center items-center gap-2 px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-md hover:bg-gray-300 transition-colors disabled:bg-gray-100"
                            >
                                <UploadCloud className="w-5 h-5" />
                                Carica Originale
                            </button>
                        </div>
                        {/* Pulsante Annulla */}
                        <button
                            type="button"
                            onClick={() => setFileToProcess(null)}
                            disabled={isProcessing}
                            className="p-2 text-gray-500 hover:text-red-600 rounded-full hover:bg-red-100 absolute top-2 right-2"
                            title="Annulla"
                        >
                            <X className="w-5 h-5" />
                        </button>
                    </div>
                </div>
            )}
            {/* --- Fine Sezione Elaborazione --- */}


            {/* Area di Upload (nascosta se stiamo elaborando un file) */}
            {!fileToProcess && hasPermission('DM_FILE_UPLOAD') && (
                <div className="space-y-4">
                    {/* Dropzone */}
                    <div {...getRootProps()} className={`border-2 border-dashed rounded-lg p-8 text-center cursor-pointer transition-colors ${isDragActive ? 'border-blue-500 bg-blue-50' : 'border-gray-300 bg-gray-50 hover:border-gray-400'}`}>
                        <input {...getInputProps()} />
                        <div className="flex flex-col items-center">
                            <UploadCloud className="w-12 h-12 text-gray-400" />
                            {isDragActive ? (
                                <p className="mt-2 text-gray-600">Rilascia il file qui...</p>
                            ) : (
                                <p className="mt-2 text-gray-600">
                                    Trascina un file qui, o <span className="font-semibold text-blue-600">clicca per selezionare</span>
                                </p>
                            )}
                            <p className="text-xs text-gray-500 mt-1">(Un file alla volta: Immagini, PDF, ZIP, ecc.)</p>
                        </div>
                    </div>

                    {/* Pulsante Fotocamera Nativa */}
                    {isCapacitor && (
                         <button
                            type="button"
                            onClick={handleTakePhoto}
                            className="w-full flex justify-center items-center gap-2 px-4 py-3 bg-blue-600 text-white font-semibold rounded-md shadow-md hover:bg-blue-700 transition-colors"
                        >
                            <CameraIcon className="w-5 h-5" />
                            Scatta Foto
                        </button>
                    )}
                </div>
            )}
            
            {/* Messaggio per permessi mancanti */}
            {!fileToProcess && !hasPermission('DM_FILE_UPLOAD') && (
                 <div className="border-2 border-dashed rounded-lg p-8 text-center bg-gray-50">
                     <p className="text-gray-500">Non hai i permessi per caricare nuovi file.</p>
                 </div>
            )}

            {/* Lista File in Caricamento */}
            {uploadingFiles.length > 0 && (
                <div className="mt-4">
                    <h4 className="font-semibold text-sm text-gray-600 mb-2">In caricamento...</h4>
                    <ul className="space-y-2">
                        {uploadingFiles.map(up => (
                            <li key={up.id} className="p-3 bg-white border rounded-md">
                                <div className="flex items-center justify-between">
                                    <span className="text-sm font-medium text-gray-700 truncate min-w-0 pr-4">{up.file.name}</span>
                                    {up.error && <AlertTriangle className="w-5 h-5 text-red-500" title={up.error} />}
                                    {up.progress === 100 && !up.error && <Loader2 className="w-5 h-5 text-green-500 animate-spin" />}
                                </div>
                                <div className="w-full bg-gray-200 rounded-full h-2 mt-2">
                                    <div className={`h-2 rounded-full transition-all ${up.error ? 'bg-red-500' : 'bg-blue-500'}`} style={{ width: up.error ? '100%' : `${up.progress}%` }}></div>
                                </div>
                                {up.error && <p className="text-xs text-red-600 mt-1">{up.error}</p>}
                            </li>
                        ))}
                    </ul>
                </div>
            )}

            {/* Lista Allegati Esistenti */}
            <div className="mt-6">
                {isLoading && (
                    <div className="flex justify-center items-center py-4">
                        <Loader2 className="w-6 h-6 text-gray-400 animate-spin" />
                        <span className="ml-2 text-gray-500">Caricamento allegati...</span>
                    </div>
                )}
                {!isLoading && allegati.length === 0 && (
                    <div className="text-center py-4 text-gray-500">Nessun allegato presente.</div>
                )}
                {!isLoading && allegati.length > 0 && (
                    <ul className="space-y-3">
                        {allegati.map(file => (
                            <li key={file.id_link} className="flex items-center justify-between p-3 bg-white border border-gray-200 rounded-md shadow-sm">
                                <div className="flex items-center min-w-0 flex-1">
                                    
                                    {/* (v2.4) LOGICA MINIATURA */}
                                    {file.mime_type.startsWith('image/') && file.previewUrl ? (
                                        <a href={file.previewUrl} target="_blank" rel="noopener noreferrer" className="flex-shrink-0">
                                            <img 
                                                src={file.previewUrl} 
                                                alt={`Anteprima di ${file.file_name_originale}`} 
                                                className="w-10 h-10 object-cover rounded-md border border-gray-200" 
                                            />
                                        </a>
                                    ) : (
                                        <div className="w-10 h-10 flex-shrink-0 flex items-center justify-center">
                                            <FileIcon mimeType={file.mime_type} />
                                        </div>
                                    )}

                                    <div className="ml-3 min-w-0 flex-1">
                                        <p className="text-sm font-medium text-gray-900 truncate">
                                            {file.file_name_originale}
                                        </p>
                                        <p className="text-xs text-gray-500">
                                            {formatFileSize(file.file_size_bytes)}
                                            <span className="mx-1">·</span>
                                            Caricato il {formatFileDate(file.created_at)}
                                            {file.utente_upload && ` da ${file.utente_upload}`}
                                        </p>
                                    </div>
                                </div>
                                <div className="flex items-center space-x-2 ml-4 flex-shrink-0">
                                    
                                    {/* (v2.4) PULSANTE ANTEPRIMA */}
                                    {file.previewUrl && hasPermission('DM_FILE_VIEW') && (
                                        <a 
                                            href={file.previewUrl} 
                                            target="_blank" 
                                            rel="noopener noreferrer"
                                            title="Anteprima"
                                            className="p-2 text-gray-500 hover:text-blue-600 rounded-full hover:bg-gray-100"
                                        >
                                            <Eye className="w-5 h-5" />
                                        </a>
                                    )}

                                    {/* (v2.2) Pulsante Download */}
                                    {hasPermission('DM_FILE_VIEW') && (
                                        <button
                                            onClick={() => handleDownload(file)}
                                            title="Download"
                                            className="p-2 text-gray-500 hover:text-blue-600 rounded-full hover:bg-gray-100"
                                        >
                                            <Download className="w-5 h-5" />
                                        </button>
                                    )}
                                    {/* (v2.2) Pulsante Delete */}
                                    {hasPermission('DM_FILE_DELETE') && (
                                        <button
                                            onClick={() => handleDeleteClick(file)}
                                            title="Scollega"
                                            className="p-2 text-gray-500 hover:text-red-600 rounded-full hover:bg-red-50"
                                        >
                                            <Trash2 className="w-5 h-5" />
                                        </button>
                                    )}
                                </div>
                            </li>
                        ))}
                    </ul>
                )}
            </div>

            {/* Modale di Conferma Eliminazione */}
            {isAllegatoDeleteModalOpen && (
                <ConfirmationModal
                    isOpen={isAllegatoDeleteModalOpen}
                    onClose={() => setIsAllegatoDeleteModalOpen(false)}
                    onConfirm={confirmDelete}
                    title="Conferma eliminazione allegato"
                    message={`Sei sicuro di voler scollegare il file "${allegatoLinkToDelete?.file_name_originale || 'file selezionato'}"? Se non è collegato ad altre entità, il file verrà eliminato definitivamente.`}
                    confirmButtonText="Scollega"
                    confirmButtonColor="red"
                />
            )}
        </div>
    );
};

export default AllegatiManager;